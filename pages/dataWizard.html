<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="">
        <script src="https://alcdn.msauth.net/browser/2.19.0/js/msal-browser.min.js"></script>
    <script defer src="authConfig.js"></script>
    <script defer src="authPopup.js"></script>

        <title>Dashboard</title>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
        <script src="https://kit.fontawesome.com/e4f70f5bb4.js" crossorigin="anonymous"></script>

        <!-- BS4 -->
        <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous"> -->

 
        <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous"> -->

        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <!-- Additional CSS Files -->
        <link rel="stylesheet" href="../css/fontawesome.css">
        <link rel="stylesheet" href="../css/templatemo-digimedia-v3.css">
        <link rel="stylesheet" href="../css/animated.css">
        <link rel="stylesheet" href="../css/owl.css">

        <!-- Bootstrap Core CSS -->
        <link href="../css/bootstrap.min.css" rel="stylesheet">

          <link rel="stylesheet" href="../css/chat.css" />

    <!-- Import this CDN to use icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css"
    />

        <!-- MetisMenu CSS -->
        <link href="../css/metisMenu.min.css" rel="stylesheet">

        <!-- Timeline CSS -->
        <link href="../css/timeline.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="../css/startmin.css" rel="stylesheet">

        <!-- Morris Charts CSS -->
        <link href="../css/morris.css" rel="stylesheet">

        <!-- Custom Fonts -->
        <link href="../css/font-awesome.min.css" rel="stylesheet" type="text/css">

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>

    <body>
        <div class="overlay">
            <div class="popup">
                <h2>Oops! ðŸ“±</h2>
                <p>This site is best viewed on desktop devices.</p>
                <p>For the best experience, please switch to a larger screen.</p>
            </div>
        </div>
    
        <div id="wrapper">

            <!-- Navigation -->
          

            <!-- /.sidebar -->
            <aside class="sidebar navbar-default" role="navigation">  
                <button id="sidebarToggle" class="btn btn-primary"><i class="fa fa-bars"></i></button>  
                <div class="sidebar-nav navbar-collapse">  
                    <ul class="nav" id="side-menu">  
                        <li class="sidebar-search">  
                            <div class="input-group">  
                                <input type="text" class="form-control custom-search-form" placeholder="Search...." style="height: 34px;">  
                                <span class="input-group-btn">  
                                    <button class="btn btn-primary" type="button"><i class="fa fa-search"></i></button>  
                                </span>  
                            </div>  
                        </li>  
                        <li>  
                            <a href="homepage.html" class="active"><i class="fa fa-home fa-fw"></i><span class="menu-text"> Home</span></a>  
                        </li>  
                        <li>  
                            <a href="index.html" class="active"><i class="fa fa-upload fa-fw"></i><span class="menu-text"> Upload Data</span></a>  
                        </li>  
                        <li>  
                            <a href="dataWizard.html" class="active"><i class="fa fa-tasks fa-fw"></i><span class="menu-text"> Data Insights</span></a>  
                        </li>  
                        <li>  
                            <a href="login.html" class="active" onclick="signOut()"><i class="fa fa-sign-out fa-fw" style="color: white;"></i><span class="menu-text"> Logout</span></a> 
                        </li>  
                    </ul>  
                </div>  
            </aside>  
            

        <nav class="navbar navbar-inverse navbar-fixed-top my-custom-navbar" role="navigation">
            <div class="navbar-header">
                <a class="navbar-brand" href="index.html">
                    <img src="../images/wipro-white-edited.webp" width="80" height="60" class="d-inline-block align-top" alt="wipro-logo" >
                  </a>
                  <!-- <a class="navbar-brand navhead" href="index.html" style="color: white; margin-bottom: 30px;"><h3 class="text-white mb-0"> -->
                    <a class="navbar-brand navhead" href="index.html" style="color: white; margin-bottom: 30px; padding: top 6px;"><h3 class="text-white mb-0">
                    Conversational Data Analyser</Data></Data><span
                      style="font-size: 1.2rem; margin-left: 10px"
                      >Powered by IntelÂ® Coreâ„¢ Ultra Processor</span></h3>
                  </h3></a>
                </div>
    
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
    
            <ul class="nav navbar-right navbar-top-links">
                <li class="dropdown">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        <!-- <i class="fa fa-user fa-fw"></i> secondtruth <b class="caret"></b> -->
                        <img src="https://wiprodemo4.service-now.com/x_wipli_hrtest.avatar_employee.jpg" class="rounded-circle dropdown-toggle" id="dropdownMenuLink" data-bs-toggle="dropdown" aria-expanded="false" style="height: 60px; width: 60px; cursor: pointer; margin-right: 10px; border-radius: 50%;">
                    </a>
                    <ul class="dropdown-menu dropdown-user">
                        <li>
                            <a href="#"><i class="fa fa-user fa-fw"></i> User Profile</a>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-gear fa-fw"></i> Settings</a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <a href="login.html" class="active" onclick="signOut()"><i class="fa fa-sign-out fa-fw" style="color: white;"></i><span class="menu-text"> Logout</span></a>
                        </li>
                    </ul>
                </li>
            </ul>
            <!-- /.navbar-top-links -->
        </nav>

        <div id="js-preloader" class="js-preloader">
            <div class="preloader-inner">
                <span class="dot"></span>
                <div class="dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
       

        <div id="page-wrapper">
                <div class="container-fluid">
                    <row>
                        <div class="twelve">
                            <h1 class="page-title">Data Insight Wizard</h1>
                        </div>
                    </row>
                    <div class="row">
                        <div class="col-lg-12">
                            <row> 
         <div class="col-lg-2">

         </div>

         <div class="col-lg-8">
            <div class="form-group input-group">
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" placeholder="Search your query for analysis" class="search-input" id="queryInput">
                        <select class="search-select" id="searchSelect">
                            <option value="">Select Project</option>
                            <!-- Options will be populated here -->
                        </select>
                        <button class="search-button" id="searchButton">
                            <i class="fa fa-search"></i>
                            <span>Visualize</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>


        <div class="row">
            <div class="col-lg-6"></div>
            <div class="col-lg-6">
                <div id="loading" style="display: none;">
                    <p>Analyzing your data with AI to deliver actionable insights...</p>
                    <img id="loading-gif" src="../images/loading.gif">
                </div>
            </div>
        </div>

        <div class="col-lg-12" id="tabView" style="display: none;">
            <div class="panel tabbed-panel panel-info">
                <div class="panel-heading clearfix">
                    <div class="pull-left">
                        <ul class="nav nav-tabs">
                            <li class="active"><a href="#tabularView" data-toggle="tab">Tabular View</a></li>
                            <li id="graphical-tab"><a href="#graphicalView" data-toggle="tab">Graphical view</a></li>
                            <li><a href="#chatview" data-toggle="tab">Chat View</a></li>
                        </ul>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="tab-content">
                        <div class="tab-pane fade in active" id="tabularView">
                            <div class="row" id="tablePanel">
                                <div class="col-lg-12">
                                    <div class="panel panel-default">
                                        <div class="panel-heading">
                                            <!-- Details -->
                                        </div>
                                        <div class="panel-body">
                                            <div class="table-responsive">
                                                <table class="table table-striped table-bordered table-hover" id="dataTables-example">
                                                    <thead>
                                                        <!-- Headers will be populated by JavaScript -->
                                                    </thead>
                                                    <tbody>
                                                        <!-- Rows will be populated by JavaScript -->
                                                    </tbody>
                                                </table>                             
                                            </div>
                                            <div class="text-right" style="margin-top: 20px;">
                                                <button id="downloadButton" class="btn btn-primary">Download Data</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                                        
                        <div class="tab-pane fade" id="graphicalView">  
                            <div class="row">  
                                <div class="col-lg-12">  
                                    <div class="col-lg-12">  
                                        <iframe src="http://localhost:8501" width="100%" height="800px" frameborder="0"></iframe>  
                                    </div>  
                                </div>  
                            </div>  
                        </div>     

                        <div class="tab-pane fade" id="chatview">
                            <div class = "row">
                                <div class="col-lg-12">  
                                    <div class="col-lg-12">  
                                        <iframe src="http://localhost:8502" width="100%" height="800px" frameborder="0"></iframe>  
                                    </div>  
                                </div> 
                            </div>  
                                </div>
                                        <!-- <div class="tab-pane fade" id="tab-primary-4">Page 4</div>
                                        <div class="tab-pane fade" id="tab-primary-5">Page 5</div> -->
                                    </div>
                                </div>
                            </div>
                            <!-- /.panel -->
                        </div>
                        </div>        
                            </div>
                            <!-- /.panel .chat-panel -->
                        </div>
                        <!-- /.col-lg-4 -->
                    </div>
                    <!-- /.row -->
                </div>
                <!-- /.container-fluid -->
            </div>
            <!-- /#page-wrapper -->
        </div>
        <!-- /#wrapper -->
        <script src="../jquery/jquery.js"></script>
    <script src="../js/bootstrap.bundle.min.js"></script>
    <script src="../js/owl-carousel.js"></script>
    <script src="../js/animation.js"></script>
    <script src="../js/imagesloaded.js"></script>
    <script src="../js/custom.js"></script>

      <!-- jQuery -->
      <script src="../js/jquery.min.js"></script>

      <!-- Bootstrap Core JavaScript -->
      <script src="../js/bootstrap.min.js"></script>

      <!-- Metis Menu Plugin JavaScript -->
      <script src="../js/metisMenu.min.js"></script>

      <!-- Morris Charts JavaScript -->
      <!-- <script src="../js/raphael.min.js"></script>
      <script src="../js/morris.min.js"></script>
      <script src="../js/morris-data.js"></script> -->

      <!-- Custom Theme JavaScript -->
      <script src="../js/startmin.js"></script>

      <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
      <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    

                    <!-- jQuery -->
                    <script src="../js/jquery.min.js"></script>

                    <!-- Bootstrap Core JavaScript -->
                    <script src="../js/bootstrap.min.js"></script>
            
                    <!-- Metis Menu Plugin JavaScript -->
                    <script src="../js/metisMenu.min.js"></script>
                    <script src="../js/morris-data.js"></script>
            
                    <!-- DataTables JavaScript -->
                    <script src="../js/dataTables/jquery.dataTables.min.js"></script>
                    <script src="../js/dataTables/dataTables.bootstrap.min.js"></script>
            
    
                    <!-- Morris Charts JavaScript -->
                    <script src="../js/raphael.min.js"></script>
                    <script src="../js/morris.min.js"></script>
                   

        <!-- bootstrap modal -->
        <!-- <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script> -->
        <script>

document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM fully loaded and parsed');

        // const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
        const apiUrl = 'http://20.232.65.230/schemas';

fetch(apiUrl)
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok ' + response.statusText);
        }
        return response.json();
    })
            .then(data => {
                console.log('Data fetched:', data);
                const selectElement = document.getElementById('searchSelect');
                const schemas = data.schemas;

                schemas.forEach(schema => {
                    const option = document.createElement('option');
                    option.value = schema;
                    option.textContent = schema;
                    selectElement.appendChild(option);
                });
            })
            .catch(error => console.error('Error fetching schemas:', error));
    });
        document.getElementById('searchButton').addEventListener('click', function () {
    // Show loading indicator
    document.getElementById('loading').style.display = 'block';
    document.getElementById('tabView').style.display = 'none';

    // Get query input value
    const query = document.getElementById('queryInput').value;

    // API URL
    const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
    const apiUrl = 'http://20.232.65.230/query';

// Fetch data from the API through the proxy
fetch(proxyUrl + apiUrl, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({ query: query })   // Update the key to match the expected field
})
    .then(response => response.json())
    .then(data => {
        // Assume data is directly an array
        let results = data.result;

        // Clear existing table headers and rows
        const table = document.getElementById('dataTables-example');
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');
        
        thead.innerHTML = '';
        tbody.innerHTML = '';

        // Check if results is not empty and is an array
        if (Array.isArray(results) && results.length > 0) {
            // Create table headers dynamically
            const headers = Object.keys(results[0]);
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            // Populate the table with new data
            results.forEach(item => {
                const row = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = item[header];
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });
        } else {
            // If no data found, display a message in a single row
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="1">No data found</td>`;
            tbody.appendChild(row);
        }

        // Hide loading indicator and show table
        document.getElementById('loading').style.display = 'none';
        document.getElementById('tabView').style.display = 'block';
    })
    .catch(error => {
        console.error('Error fetching data:', error);
        alert('Failed to fetch data. Please try again later.');

        // Hide loading indicator
        document.getElementById('loading').style.display = 'none';
    });
});

document.getElementById('downloadButton').addEventListener('click', function() {
    // Function to convert table data to CSV format
    function tableToCSV() {
        let csv = [];
        let rows = document.querySelectorAll("#dataTables-example tr");

        for (let i = 0; i < rows.length; i++) {
            let row = [], cols = rows[i].querySelectorAll("td, th");

            for (let j = 0; j < cols.length; j++) {
                row.push(cols[j].innerText);
            }

            csv.push(row.join(","));
        }

        return csv.join("\n");
    }

    // Function to download the CSV file
    function downloadCSV(csv, filename) {
        let csvFile;
        let downloadLink;

        csvFile = new Blob([csv], {type: "text/csv"});
        downloadLink = document.createElement("a");
        downloadLink.download = filename;
        downloadLink.href = window.URL.createObjectURL(csvFile);
        downloadLink.style.display = "none";

        document.body.appendChild(downloadLink);
        downloadLink.click();
    }

    // Get the table data as CSV and download it
    let csv = tableToCSV();
    downloadCSV(csv, "table_data.csv");
});

document.getElementById('searchSelect').addEventListener('change', function() {
    const selectedValue = this.value;
    const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
    const apiUrl = 'http://20.232.65.230/set_db_name';
    
    if (selectedValue) {
        fetch(proxyUrl + apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ db_name: selectedValue })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Success:', data);
            // Optionally, you can add more actions here, like updating the UI
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    }
});


const msgerForm = document.querySelector(".msger-inputarea");
const msgerInput = document.querySelector(".msger-input");
const msgerChat = document.querySelector(".msger-chat");

const BOT_IMG = "../assets/bot.png";
const PERSON_IMG = "https://wiprodemo4.service-now.com/x_wipli_hrtest.avatar_employee.jpg";
const BOT_NAME = "Data Wiz";
const PERSON_NAME = "Adarsh";

msgerForm.addEventListener("submit", event => {
    event.preventDefault();

    const msgText = msgerInput.value;
    if (!msgText) return;

    appendMessage(PERSON_NAME, PERSON_IMG, "right", msgText);
    msgerInput.value = "";

    botResponse(msgText);
});

function appendMessage(name, img, side, text) {
    const msgHTML = `
        <div class="msg ${side}-msg">
          <div class="msg-img" style="background-image: url(${img})"></div>
          <div class="msg-bubble">
            <div class="msg-info">
              <div class="msg-info-name">${name}</div>
              <div class="msg-info-time">${formatDate(new Date())}</div>
            </div>
            <div class="msg-text">${text}</div>
          </div>
        </div>
    `;
    msgerChat.insertAdjacentHTML("beforeend", msgHTML);
    msgerChat.scrollTop += 500;
}

async function botResponse(userMsg) {
    try {
        const response = await fetch('http://127.0.0.1:8004/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ query: userMsg })  // Ensure the key is 'query'
        });
        const data = await response.json();
        let botMsg;

        if (Array.isArray(data.response)) {
            botMsg = formatTable(data.response);
        } else {
            botMsg = data.response;
        }

        appendMessage(BOT_NAME, BOT_IMG, "left", botMsg);
    } catch (error) {
        console.error('Error:', error);
        appendMessage(BOT_NAME, BOT_IMG, "left", "Sorry, there was an error. Please try again later.");
    }
}

// async function botResponse(userMsg) {
//     try {
//         const response = await fetch('http://127.0.0.1:8005/generate', {
//             method: 'POST',
//             headers: {
//                 'Content-Type': 'application/json'
//             },
//             body: JSON.stringify({ query: userMsg })  // Ensure the key is 'query'
//         });
//         const data = await response.json();
//         let botMsg;

//         if (Array.isArray(data.response)) {
//             botMsg = formatTable(data.response);
//         } else {
//             botMsg = data.response;
//         }

//         appendMessage(BOT_NAME, BOT_IMG, "left", botMsg);
//     } catch (error) {
//         console.error('Error:', error);
//         appendMessage(BOT_NAME, BOT_IMG, "left", "Sorry, there was an error. Please try again later.");
//     }
// }


function formatTable(data) {
    if (!Array.isArray(data) || data.length === 0) return "No data available.";
    
    const headers = data[0];
    if (!Array.isArray(headers)) return "Invalid data format.";
    
    const rows = data.slice(1);
    
    let tableHTML = "<table border='1'><thead><tr>";
    headers.forEach(header => {
        tableHTML += `<th>${header}</th>`;
    });
    tableHTML += "</tr></thead><tbody>";
    
    rows.forEach(row => {
        if (!Array.isArray(row)) return; // Skip invalid rows
        tableHTML += "<tr>";
        row.forEach(cell => {
            tableHTML += `<td>${cell}</td>`;
        });
        tableHTML += "</tr>";
    });
    
    tableHTML += "</tbody></table>";
    return tableHTML;
}

function formatDate(date) {
    const h = "0" + date.getHours();
    const m = "0" + date.getMinutes();
    return `${h.slice(-2)}:${m.slice(-2)}`;
}
            function random(min, max) {
                return Math.floor(Math.random() * (max - min) + min);
            }
    
            let charDisplayed = false;
    
            $('#graphical-tab').click(function () {
                if (!charDisplayed) {
                    setTimeout(function () {
                        displaychart();
                        charDisplayed = true;
                    }, 500)
                }
            });
    
            $(document).ready(function () {
                $(".nav-link").click(function () {
                    $(".nav-link").removeClass("active");
                    $(this).addClass("active");
                });
    
                $('#dataTables-example').DataTable({
                    responsive: true
                });
    
                $("td").click(function () {
                    alert($(this).text());
                });
    
                $("#searchButton").click(function () {
                $("#loading").show();
                setTimeout(function () {
                    $("#loading").hide();
                    $("#tabView").show();
                }, 60000); // Set to 30 seconds
            });
                $("#searchButton").click(function () {
                    $("#loading1").show();  // Show loading GIF
    
                    setTimeout(function () {
                        $("#loading1").hide();   // Hide loading GIF
                        $("#tablePanel").show();
                        $("#fetchTopbar").show();
                        // Show analytics section
                        // Call your function to display charts
                    }, 1500);
                });
            });
        </script>

        <script>  
        document.addEventListener('DOMContentLoaded', function () {  
            const sidebar = document.querySelector('.sidebar');  
            const pageWrapper = document.querySelector('#page-wrapper');  
            const toggleButton = document.querySelector('#sidebarToggle');  

            toggleButton.addEventListener('click', function () {  
                sidebar.classList.toggle('minimized');  
                pageWrapper.classList.toggle('minimized');  
            });  
        });  
        </script> 
    
        <div class="bottoms">
            <div class="bottoms-content">
                <p>Â© 2024 Wipro Ltd. All rights reserved.
                </p>
            </div>
            <div class="bottoms-content">
                <p>Powered by Generative AI</p>
            </div>
        </div>
    
    </body>
    
    </html>
